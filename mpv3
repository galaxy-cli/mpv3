#!/bin/bash
#        _ __ ___  _ ____   __
#       | '_ ` _ \| '_ \ \ / /
#       | | | | | | |_) \ V /
#       |_| |_| |_| .__/ \_/
#                 |_|
# mpv3 - Text-to-speech and playback utility using Festival, LAME, and MPV
# Author: galaxy-cli
# Project: https://github.com/galaxy-cli/mpv

# --- Dependency Check & Install Section ---

missing=()

for cmd in git festival xsel lame mpv; do
    command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
done

# Check for tgpt (special case: directory and command)
if ! command -v tgpt >/dev/null 2>&1; then
    missing+=("tgpt")
fi

if [ "${#missing[@]}" -gt 0 ]; then
    echo "The following dependencies are missing: ${missing[*]}"
    read -p "Do you want to install them now? [Y/n] " yn
    yn=${yn:-Y}
    if [[ $yn =~ ^[Yy]$ ]]; then
        sudo apt update
        # Install system packages
        for pkg in festival xsel lame mpv; do
            if [[ " ${missing[*]} " == *" $pkg "* ]]; then
                sudo apt install -y "$pkg"
            fi
        done
        # Install tgpt if missing
        if [[ " ${missing[*]} " == *" tgpt "* ]]; then
            if [ -d tgpt ]; then
                echo "tgpt directory already exists. Skipping clone."
            else
                git clone https://github.com/aandrew-me/tgpt.git
                sh tgpt/install
            fi
        fi
    else
        echo "Cannot continue without required dependencies."
        exit 1
    fi
fi

# --- Main Script Section ---

# Edit Festival default speed by changing Duration_Stretch in:
# /usr/share/festival/voices/english/kal_diphone/festvox/kal_diphone.scm
# Line 265: (Parameter.set 'Duration_Stretch 0.8)

textfile=$(mktemp /tmp/mpv3_text.XXXXXX)
wavfile=$(mktemp /tmp/mpv3_audio.XXXXXX.wav)
mp3file=$(mktemp /tmp/mpv3_audio.XXXXXX.mp3)
trap 'rm -f "$textfile" "$wavfile" "$mp3file"' INT EXIT

print_usage() {
    cat <<EOF
USAGE
  mpv3 --clip [--speed NUM] [--play-once] [--no-save]
  mpv3 --file FILE [--speed NUM] [--play-once] [--no-save]
  mpv3 --user [--speed NUM] [--play-once] [--no-save]
  mpv3 --tgpt [--speed NUM] [--play-once] [--no-save]
FLAGS
  --clip       Use clipboard (xsel)
  --file       Open and play a file
  --user       Echo user input
  --tgpt       Use tgpt output
  --speed      Set TTS speed (Festival Duration_Stretch, e.g. 0.5 = faster, 1.5 = slower)
  --play-once  Play audio once, skip replay prompt
  --no-save    Skip prompt to save the MP3 file
EOF
}

# --- Option parsing ---
input_source=""
file_name=""
speed=""
text=""
play_once=false    # <-- Added for --play-once option
no_save=false      # <-- Added for --no-save option

while [[ $# -gt 0 ]]; do
    case "$1" in
        --clip)
            input_source="clip"
            shift
            ;;
        --file)
            input_source="file"
            file_name="$2"
            shift 2
            ;;
        --user)
            input_source="user"
            shift
            ;;
        --tgpt)
            input_source="tgpt"
            shift
            ;;
        --speed)
            speed="$2"
            shift 2
            ;;
        --play-once)
            play_once=true         # <-- Set flag if option present
            shift
            ;;
        --no-save)
            no_save=true           # <-- Set flag if option present
            shift
            ;;
        *)
            text="$*"
            break
            ;;
    esac
done

# --- Get text from selected source ---
if [[ -z "$text" ]]; then
    case "$input_source" in
        clip)
            text="$(xsel)"
            ;;
        file)
            text="$(cat "$file_name")"
            ;;
        user)
            read -r text
            ;;
        tgpt)
	    text="$(tgpt)"
            ;;
        *)
            print_usage
            exit 1
            ;;
    esac
fi

# --- Write text to temp file ---
echo "$text" > "$textfile"

# --- Generate WAV with or without speed ---
if [[ -n "$speed" ]]; then
    # Escape double quotes in text
    escaped_text=$(printf '%s' "$text" | sed 's/"/\\"/g')
    echo "(Parameter.set 'Duration_Stretch $speed) (utt.save.wave (SayText \"$escaped_text\") \"$wavfile\" 'riff)" | festival --pipe
else
    text2wave "$textfile" -o "$wavfile"
fi

# --- Encode to MP3 ---
lame "$wavfile" "$mp3file"

# --- Play sound, possibly only once ---
mpv "$mp3file"

# Only prompt "Pay again" if not --play-once
if ! $play_once; then
    while true; do
        read -rp "Pay again? [Y/n] " pay_answer
        case "$pay_answer" in
            [Yy]*)
                mpv "$mp3file"
                ;;
            [Nn]*)
                break
                ;;
            *)
                echo "Please answer Y or n."
                ;;
        esac
    done
fi

# --- Prompt to save MP3 unless --no-save ---
if ! $no_save; then
    while true; do
        read -rp "Do you want to save the MP3 file? [Y/n] " save_answer
        case "$save_answer" in
            [Yy]* )
                read -rp "Enter filename to save as (without .mp3) " user_filename
                user_filename="${user_filename%.mp3}.mp3"
                if [ -e "$user_filename" ]; then
                    read -rp "File exists. Overwrite? [Y/n] " overwrite
                    if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
                        echo "Not saving."
                        break
                    fi
                fi
                mv "$mp3file" "$user_filename"
                echo "Saved as $user_filename"
                trap 'rm -f "$textfile" "$wavfile"' INT EXIT
                break
                ;;
            [Nn]* )
                echo "MP3 not saved"
                break
                ;;
            * )
                echo "Please answer Y or n."
                ;;
        esac
    done
fi
