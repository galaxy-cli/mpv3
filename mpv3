#!/bin/bash
#        _ __ ___  _ ____   __
#       | '_ ` _ \| '_ \ \ / /
#       | | | | | | |_) \ V /
#       |_| |_| |_| .__/ \_/
#                 |_|
# mpv3 - Text-to-speech and playback utility using Festival, LAME, and MPV
# Author: galaxy-cli
# Project: https://github.com/galaxy-cli/mpv

# --- Dependency Check & Install Section ---

missing=()

for cmd in festival xsel lame mpv; do
    command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
done

# Check for tgpt (special case: directory and command)
if ! command -v tgpt >/dev/null 2>&1; then
    missing+=("tgpt")
fi

if [ "${#missing[@]}" -gt 0 ]; then
    echo "The following dependencies are missing: ${missing[*]}"
    read -p "Do you want to install them now? [Y/n] " yn
    yn=${yn:-Y}
    if [[ $yn =~ ^[Yy]$ ]]; then
        sudo apt update
        # Install system packages
        for pkg in festival xsel lame mpv; do
            if [[ " ${missing[*]} " == *" $pkg "* ]]; then
                sudo apt install -y "$pkg"
            fi
        done
        # Install tgpt if missing
        if [[ " ${missing[*]} " == *" tgpt "* ]]; then
            if [ -d tgpt ]; then
                echo "tgpt directory already exists. Skipping clone."
            else
                git clone https://github.com/aandrew-me/tgpt.git
                sh tgpt/install
            fi
        fi
    else
        echo "Cannot continue without required dependencies."
        exit 1
    fi
fi

# --- Main Script Section ---

# Edit Festival speed by changing Duration_Stretch in:
# /usr/share/festival/voices/english/kal_diphone/festvox/kal_diphone.scm
# Line 265: (Parameter.set 'Duration_Stretch 0.8)

textfile=$(mktemp /tmp/mpv3_text.XXXXXX)
mp3file=$(mktemp /tmp/mpv3_audio.XXXXXX.mp3)
trap 'rm -f "$textfile" "$mp3file"' INT EXIT

print_usage() {
    cat <<EOF
USAGE
  mpv3 --cursor
  mpv3 --file FILE
  mpv3 --user
  mpv3 --tgpt
FLAGS
  --cursor    Use clipboard (xsel)
  --file    Open and play a file
  --user    Echo user input
  --tgpt    Use tgpt output
EOF
}

text2lame() {
    text2wave "$textfile" | lame - "$mp3file"
    mpv "$mp3file"
}

mpv_clipboard() {
    xsel > "$textfile"
    text2lame
}

mpv_file() {
    cat "$1" > "$textfile"
    text2lame
}

mpv_input() {
    read -r input
    echo "$input" > "$textfile"
    text2lame
}

mpv_tgpt() {
    tgpt > "$textfile"
    text2lame
}

case "${1:-}" in
    --cursor) mpv_clipboard ;;
    --file) mpv_file "${2:-}" ;;
    --user) mpv_input ;;
    --tgpt) mpv_tgpt ;;
    *)  print_usage ;;
esac
